language: node_js
node_js:
- 13.11.0
branches:
  only:
    - master
    - "/^v\\d+\\.\\d+(\\.\\d+)?(-\\S*)?$/"
import:
 - source: streamr-dev/travis-ci:aws-staging-secrets.yml@master
 - source: streamr-dev/travis-ci:npm-secrets.yml@master
before_install:
- npm i -g npm@6.14.2
- npm config set //registry.npmjs.org/:_authToken=$NPM_TOKEN
jobs:
  include:
  - stage: Tests
    name: Integration Tests
    script: npm run test-integration
  - stage: Tests
    name: Unit Tests
    script: npm run test-unit
  - stage: Tests
    name: eslint
    script: npm run eslint
  - stage: publish
    if: tag IS present
    script: npm publish
  - stage: Deploy Staging
    if: NOT type IN (pull_request)
    script:
    - mkdir $TRAVIS_BUILD_DIR/build
    - mkdir $TRAVIS_BUILD_DIR/upload
    - cp -r src build
    - cp -r bin build
    - cp package.json build
    - cp package-lock.json build
    - mv .codedeploy-stg/appspec.yml build/appspec.yml
    - mv .codedeploy-stg/ build/.codedeploy
    - cd build; tar -czvf $TRAVIS_BUILD_DIR/upload/tracker-${TRAVIS_JOB_ID}.tar .;tar
      -czvf $TRAVIS_BUILD_DIR/upload/latest.tar .;
    - cd $TRAVIS_BUILD_DIR;
    deploy:
    - provider: s3
      access_key_id: $ACCESS_KEY_STG
      secret_access_key: $SECRET_ACCESS_KEY_STG
      bucket: eu-west-1-stg-streamr-vault
      upload-dir: tracker-node/releases
      acl: private
      region: eu-west-1
      skip_cleanup: true
      local_dir: upload
    - provider: codedeploy
      access_key_id: $ACCESS_KEY_STG
      secret_access_key: $SECRET_ACCESS_KEY_STG
      bucket: eu-west-1-stg-streamr-vault
      key: tracker-node/releases/tracker-${TRAVIS_JOB_ID}.tar
      application: eu-west-1-stg-tracker-node-codedeploy
      deployment_group: eu-west-1-stg-tracker-node-deployment-group
      region: eu-west-1